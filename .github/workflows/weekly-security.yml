name: Weekly Security and Full System Tests

on:
  schedule:
    # Run every Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:

env:
  PYTHONPATH: ${{ github.workspace }}
  TEST_MODE: "true"

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install security tools
        run: |
          pip install bandit safety pip-audit

      - name: Run Bandit (Python security linter)
        run: |
          bandit -r backend/ src/ scripts/ -ll -ii --format json -o bandit-report.json || true
          bandit -r backend/ src/ scripts/ -ll -ii --format txt || true
        continue-on-error: true

      - name: Run Safety (dependency vulnerabilities)
        run: |
          safety check -r requirements.txt --output json > safety-report.json || true
          safety check -r requirements.txt || true
        continue-on-error: true

      - name: Run pip-audit
        run: |
          pip-audit --format json > pip-audit-report.json || true
          pip-audit || true
        continue-on-error: true

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
            pip-audit-report.json
          retention-days: 90

  full-knowledge-extraction:
    name: Full Knowledge Extraction E2E
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 50

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r backend/requirements.txt
          pip install pytest-cov pytest-asyncio pytest-xdist

      - name: Create comprehensive test vault
        run: |
          mkdir -p test_vault/.obsidian
          mkdir -p test_vault/개발일지
          mkdir -p test_vault/3-Areas/UDO/{Analysis,Features}
          mkdir -p test_vault/4-Resources/Decisions
          mkdir -p test_vault/claudedocs-archive/udo-platform/{worklog,analysis}

          cat > test_vault/claudedocs-archive/udo-platform/INDEX.md << 'EOF'
          # Archive Index
          ## Archived Files
          - worklog/2025-01-01-worklog.md
          - analysis/2025-01-01-TEST-ANALYSIS.md
          EOF

          echo "# Test Worklog" > test_vault/claudedocs-archive/udo-platform/worklog/2025-01-01-worklog.md
          echo "# Test Analysis" > test_vault/claudedocs-archive/udo-platform/analysis/2025-01-01-TEST-ANALYSIS.md

          # Create sample files for performance testing
          for i in $(seq 1 50); do
            mkdir -p "test_vault/개발일지/2025-01-$(printf '%02d' $((i % 28 + 1)))"
            echo "# Dev Log $i" > "test_vault/개발일지/2025-01-$(printf '%02d' $((i % 28 + 1)))/log_$i.md"
          done
        env:
          OBSIDIAN_VAULT_PATH: "${{ github.workspace }}/test_vault"

      - name: Run full test suite
        run: |
          python -m pytest tests/test_obsidian_3stage_search.py -v --tb=short --cov=scripts --cov-report=xml || true
          python -m pytest tests/test_consolidate_obsidian_duplicates.py -v --tb=short || true
          python -m pytest backend/tests/test_obsidian_service.py -v --tb=short || true
          python -m pytest backend/tests/test_obsidian_debouncing.py -v --tb=short || true
        env:
          OBSIDIAN_VAULT_PATH: "${{ github.workspace }}/test_vault"

      - name: E2E Knowledge Extraction Flow
        run: |
          python -c "
          import os
          import sys
          from pathlib import Path

          sys.path.insert(0, '.')
          os.environ['TEST_MODE'] = 'true'
          os.environ['OBSIDIAN_VAULT_PATH'] = 'test_vault'

          print('=== E2E Knowledge Extraction Flow ===')

          # Step 1: Verify archive structure
          archive_path = Path('test_vault/claudedocs-archive/udo-platform')
          assert archive_path.exists(), 'Archive path missing'
          print('Step 1: Archive structure verified')

          # Step 2: Verify dev log directory
          dev_log = Path('test_vault/개발일지')
          assert dev_log.exists(), 'Dev log directory missing'
          print('Step 2: Dev log directory verified')

          # Step 3: Count test files
          md_count = sum(1 for _ in Path('test_vault').rglob('*.md'))
          print(f'Step 3: Found {md_count} markdown files')

          # Step 4: Performance check
          import time
          start = time.time()
          for _ in Path('test_vault').rglob('*.md'):
              pass
          elapsed = time.time() - start
          print(f'Step 4: File enumeration took {elapsed:.3f}s')

          print('=== E2E Flow Complete ===')
          "

      - name: Upload coverage
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: knowledge-extraction
          name: knowledge-extraction-coverage
        continue-on-error: true

  full-backend-tests:
    name: Full Backend Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r backend/requirements.txt
          pip install pytest-cov pytest-xdist pytest-asyncio

      - name: Run complete backend tests
        run: |
          python -m pytest backend/tests/ -v --tb=short --cov=backend --cov-report=html --cov-report=xml -n auto
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-weekly-coverage
          path: |
            htmlcov/
            coverage.xml
          retention-days: 30

  weekly-summary:
    name: Weekly Test Summary
    runs-on: ubuntu-latest
    needs: [security-scan, full-knowledge-extraction, full-backend-tests]
    if: always()

    steps:
      - name: Create summary
        run: |
          echo "## Weekly Comprehensive Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Knowledge Extraction E2E | ${{ needs.full-knowledge-extraction.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Full Backend Tests | ${{ needs.full-backend-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.security-scan.result }}" == "success" && "${{ needs.full-knowledge-extraction.result }}" == "success" && "${{ needs.full-backend-tests.result }}" == "success" ]]; then
            echo "All weekly tests passed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "Some tests require attention. Please review the logs." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "::warning::Weekly comprehensive tests had failures. Review required."
