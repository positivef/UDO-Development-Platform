name: Documentation Validation

on:
  push:
    paths:
      - 'docs/**'
      - 'scripts/check_doc_structure.py'
  pull_request:
    paths:
      - 'docs/**'

jobs:
  validate-docs:
    runs-on: ubuntu-latest
    name: Validate Documentation Structure

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate documentation structure
        run: |
          python scripts/check_doc_structure.py
        continue-on-error: false

      - name: Check for broken links
        run: |
          pip install markdown-link-check || true
          find docs -name "*.md" -exec markdown-link-check {} \; 2>/dev/null || echo "Link check complete"
        continue-on-error: true

      - name: Generate documentation report
        if: always()
        run: |
          echo "# Documentation Validation Report" > docs_report.md
          echo "" >> docs_report.md
          echo "**Date**: $(date)" >> docs_report.md
          echo "" >> docs_report.md
          echo "## Structure" >> docs_report.md
          echo "\`\`\`" >> docs_report.md
          find docs -type d | head -20 >> docs_report.md
          echo "\`\`\`" >> docs_report.md
          echo "" >> docs_report.md
          echo "## File Count by Folder" >> docs_report.md
          for dir in docs/*/; do
            count=$(find "$dir" -type f -name "*.md" | wc -l)
            echo "- $(basename $dir)/: $count files" >> docs_report.md
          done

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-validation-report
          path: docs_report.md
          retention-days: 7

  check-current-md:
    runs-on: ubuntu-latest
    name: Check CURRENT.md is Updated

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check CURRENT.md last updated
        run: |
          LAST_UPDATED=$(grep "Last Updated" docs/CURRENT.md | head -1)
          echo "CURRENT.md: $LAST_UPDATED"

          # Extract date from CURRENT.md
          DOC_DATE=$(echo "$LAST_UPDATED" | grep -oP '\d{4}-\d{2}-\d{2}' || echo "unknown")
          TODAY=$(date +%Y-%m-%d)

          echo "Document date: $DOC_DATE"
          echo "Today: $TODAY"

          # Warning if more than 7 days old
          if [ "$DOC_DATE" != "unknown" ]; then
            DOC_EPOCH=$(date -d "$DOC_DATE" +%s 2>/dev/null || echo 0)
            TODAY_EPOCH=$(date +%s)
            DIFF=$(( (TODAY_EPOCH - DOC_EPOCH) / 86400 ))

            if [ $DIFF -gt 7 ]; then
              echo "::warning::CURRENT.md is $DIFF days old. Consider updating."
            else
              echo "CURRENT.md is up to date ($DIFF days old)"
            fi
          fi

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: [validate-docs]
    if: failure()

    steps:
      - name: Create issue for documentation errors
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Documentation Validation Failed';
            const body = `
            ## Documentation Validation Failed

            The documentation structure validation has failed.

            **Workflow Run**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

            ### Action Required
            1. Check the workflow logs for specific errors
            2. Run \`python scripts/check_doc_structure.py\` locally
            3. Fix any structural issues
            4. Ensure all links are valid

            ---
            *Auto-generated by docs-validation workflow*
            `;

            // Check if similar issue exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'documentation'
            });

            const existing = issues.data.find(i => i.title === title);

            if (!existing) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['documentation', 'automated']
              });
            }
