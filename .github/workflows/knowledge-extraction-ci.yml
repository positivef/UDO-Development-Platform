name: Knowledge Extraction CI

on:
  pull_request:
    branches: [main]
    paths:
      - 'scripts/obsidian_*.py'
      - 'scripts/consolidate_*.py'
      - 'backend/app/services/obsidian_service.py'
      - 'tests/test_obsidian_*.py'
      - 'tests/test_consolidate_*.py'
      - 'backend/tests/test_obsidian_*.py'
  push:
    branches: [main]
    paths:
      - 'scripts/obsidian_*.py'
      - 'scripts/consolidate_*.py'
  workflow_dispatch:

env:
  TEST_MODE: "true"
  OBSIDIAN_VAULT_PATH: "${{ github.workspace }}/test_vault"
  CI: "true"
  PYTHONPATH: ${{ github.workspace }}

jobs:
  unit-tests:
    name: Knowledge Extraction Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r backend/requirements.txt
          pip install pytest-cov pytest-xdist pytest-asyncio

      - name: Create test vault structure
        run: |
          mkdir -p test_vault/.obsidian
          mkdir -p test_vault/개발일지
          mkdir -p test_vault/3-Areas/UDO/Analysis
          mkdir -p test_vault/4-Resources/Decisions
          echo "# Test Vault" > test_vault/README.md

      - name: Run unit tests (fast)
        run: |
          python -m pytest tests/test_obsidian_3stage_search.py -v --tb=short -x --timeout=30 || true
          python -m pytest tests/test_consolidate_obsidian_duplicates.py -v --tb=short -x --timeout=60 || true
        env:
          PYTEST_CURRENT_TEST: "1"

      - name: Run backend obsidian tests (sync only)
        run: |
          python -m pytest backend/tests/test_obsidian_service.py -v --tb=short -k "not async" --timeout=60 || true

  integration-tests:
    name: Knowledge Extraction Integration
    runs-on: ubuntu-latest
    needs: unit-tests
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 10

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r backend/requirements.txt
          pip install pytest-cov pytest-xdist pytest-asyncio

      - name: Create comprehensive test vault
        run: |
          mkdir -p test_vault/.obsidian
          mkdir -p "test_vault/개발일지/$(date +%Y-%m-%d)"
          mkdir -p test_vault/3-Areas/UDO/Analysis
          mkdir -p test_vault/4-Resources/Decisions
          mkdir -p test_vault/claudedocs-archive/test-project

          echo "# Sample Dev Log" > "test_vault/개발일지/$(date +%Y-%m-%d)/sample.md"
          echo "# Analysis" > test_vault/3-Areas/UDO/Analysis/test-analysis.md

      - name: Run async integration tests
        run: |
          python -m pytest backend/tests/test_obsidian_service.py -v --tb=short --timeout=120 || true
          python -m pytest backend/tests/test_obsidian_debouncing.py -v --tb=short --timeout=120 || true

      - name: Verify extraction performance
        run: |
          python -c "
          import time
          import sys
          import os

          sys.path.insert(0, '.')
          os.environ['TEST_MODE'] = 'true'
          os.environ['OBSIDIAN_VAULT_PATH'] = 'test_vault'

          print('=== Knowledge Extraction Performance Check ===')

          # Test 1: File enumeration
          start = time.time()
          count = 0
          for root, dirs, files in os.walk('test_vault'):
              for f in files:
                  if f.endswith('.md'):
                      count += 1
          elapsed = time.time() - start
          print(f'File enumeration ({count} files): {elapsed:.3f}s')

          # Test 2: Import time
          start = time.time()
          try:
              from scripts.obsidian_3stage_search import ObsidianSearcher
              elapsed = time.time() - start
              print(f'Module import: {elapsed:.3f}s')
          except Exception as e:
              print(f'Module import failed (expected): {e}')

          print('=== Performance Check Complete ===')
          "

  test-summary:
    name: Knowledge Extraction Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: always()

    steps:
      - name: Create summary
        run: |
          echo "## Knowledge Extraction Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.unit-tests.result }}" == "success" && "${{ needs.integration-tests.result }}" == "success" ]]; then
            echo "All knowledge extraction tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "Some tests need attention. Check logs above." >> $GITHUB_STEP_SUMMARY
          fi
