"""
Module Management API Router

Standard 레벨 모듈 점유 관리 API
"""

from fastapi import APIRouter, HTTPException, Depends, Query
from typing import List, Optional, Dict, Any
from datetime import datetime
from pydantic import BaseModel, Field

from app.services.module_ownership_manager import (
    get_module_manager,
    ModuleStatus,
    CompletionCriteria
)
from app.services.session_manager_v2 import get_session_manager

router = APIRouter(
    prefix="/api/modules",
    tags=["modules"]
)


# ========================
# Request/Response Models
# ========================

class ClaimModuleRequest(BaseModel):
    """모듈 점유 요청"""
    module_id: str = Field(..., description="모듈 ID (예: auth/login)")
    session_id: str = Field(..., description="세션 ID")
    developer_name: str = Field(..., description="개발자 이름")
    estimated_hours: Optional[float] = Field(None, description="예상 작업 시간")


class UpdateModuleStatusRequest(BaseModel):
    """모듈 상태 업데이트 요청"""
    session_id: str = Field(..., description="세션 ID")
    new_status: str = Field(..., description="새로운 상태")
    progress: Optional[int] = Field(None, ge=0, le=100, description="진행률")
    commit_hash: Optional[str] = Field(None, description="커밋 해시")


class ReleaseModuleRequest(BaseModel):
    """모듈 해제 요청"""
    session_id: str = Field(..., description="세션 ID")
    reason: Optional[str] = Field(None, description="해제 사유")


class ModuleAvailabilityResponse(BaseModel):
    """모듈 가용성 응답"""
    available: bool
    reason: Optional[str] = None
    owner: Optional[str] = None
    status: Optional[str] = None
    estimated_available: Optional[datetime] = None
    alternatives: List[str] = []
    warnings: List[str] = []
    can_override: bool = False


class ModuleOwnershipResponse(BaseModel):
    """모듈 점유 정보 응답"""
    module_id: str
    owner_session: str
    developer_name: str
    status: str
    started_at: datetime
    estimated_completion: datetime
    actual_completion: Optional[datetime] = None
    completion_criteria: List[str] = []
    blockers: List[str] = []
    warnings: List[str] = []
    progress: int = 0
    commits: List[str] = []


class ModuleStatusBoardResponse(BaseModel):
    """모듈 현황판 응답"""
    active: List[Dict[str, Any]]
    available: List[Dict[str, Any]]
    blocked: List[Dict[str, Any]]
    completed: List[Dict[str, Any]]


# ========================
# API Endpoints
# ========================

@router.get("/status-board", response_model=ModuleStatusBoardResponse)
async def get_module_status_board():
    """
    모듈 현황판 조회

    전체 모듈의 현재 상태를 한눈에 볼 수 있는 대시보드 데이터를 반환합니다.
    """
    try:
        manager = await get_module_manager()
        board = await manager.get_module_status_board()
        return ModuleStatusBoardResponse(**board)
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/{module_id:path}/availability", response_model=ModuleAvailabilityResponse)
async def check_module_availability(
    module_id: str,
    session_id: str = Query(..., description="세션 ID"),
    developer_name: str = Query(..., description="개발자 이름")
):
    """
    모듈 개발 가능 여부 확인

    지정된 모듈을 개발할 수 있는지 확인합니다.
    다른 개발자가 점유 중이거나 의존성이 해결되지 않은 경우 false를 반환합니다.
    """
    try:
        manager = await get_module_manager()
        availability = await manager.check_module_availability(
            module_id=module_id,
            session_id=session_id,
            developer_name=developer_name
        )

        return ModuleAvailabilityResponse(
            available=availability.available,
            reason=availability.reason,
            owner=availability.owner,
            status=availability.status.value if availability.status else None,
            estimated_available=availability.estimated_available,
            alternatives=availability.alternatives,
            warnings=availability.warnings,
            can_override=availability.can_override
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/{module_id:path}/claim", response_model=ModuleOwnershipResponse)
async def claim_module(
    module_id: str,
    request: ClaimModuleRequest
):
    """
    모듈 점유

    모듈 개발을 시작하기 위해 점유를 요청합니다.
    Standard 레벨에서는 한 번에 한 명만 모듈을 점유할 수 있습니다.
    """
    try:
        manager = await get_module_manager()

        # 모듈 ID 검증
        if request.module_id != module_id:
            raise ValueError("Module ID mismatch")

        success, ownership = await manager.claim_module(
            module_id=module_id,
            session_id=request.session_id,
            developer_name=request.developer_name,
            estimated_hours=request.estimated_hours
        )

        if not success:
            raise HTTPException(status_code=409, detail="Module claim failed")

        return ModuleOwnershipResponse(
            module_id=ownership.module_id,
            owner_session=ownership.owner_session,
            developer_name=ownership.developer_name,
            status=ownership.status.value,
            started_at=ownership.started_at,
            estimated_completion=ownership.estimated_completion,
            actual_completion=ownership.actual_completion,
            completion_criteria=[c.value for c in ownership.completion_criteria],
            blockers=ownership.blockers,
            warnings=ownership.warnings,
            progress=ownership.progress,
            commits=ownership.commits
        )
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@router.put("/{module_id:path}/status")
async def update_module_status(
    module_id: str,
    request: UpdateModuleStatusRequest
):
    """
    모듈 상태 업데이트

    모듈의 개발 상태를 업데이트합니다.
    (planning → coding → testing → review → completed)
    """
    try:
        manager = await get_module_manager()

        # 상태 문자열을 Enum으로 변환
        new_status = ModuleStatus(request.new_status)

        success = await manager.update_module_status(
            module_id=module_id,
            session_id=request.session_id,
            new_status=new_status,
            progress=request.progress,
            commit_hash=request.commit_hash
        )

        if not success:
            raise HTTPException(status_code=404, detail="Module not found or not owned")

        return {"success": True, "message": f"Module status updated to {new_status.value}"}

    except ValueError as e:
        raise HTTPException(status_code=403, detail=str(e))
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/{module_id:path}/release")
async def release_module(
    module_id: str,
    request: ReleaseModuleRequest
):
    """
    모듈 점유 해제

    모듈 점유를 해제하여 다른 개발자가 작업할 수 있도록 합니다.
    """
    try:
        manager = await get_module_manager()

        success = await manager.release_module(
            module_id=module_id,
            session_id=request.session_id,
            reason=request.reason
        )

        if not success:
            raise HTTPException(status_code=404, detail="Module not found or not owned")

        return {"success": True, "message": "Module released successfully"}

    except ValueError as e:
        raise HTTPException(status_code=403, detail=str(e))
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/{module_id:path}/ownership", response_model=Optional[ModuleOwnershipResponse])
async def get_module_ownership(module_id: str):
    """
    모듈 점유 정보 조회

    특정 모듈의 현재 점유 정보를 조회합니다.
    """
    try:
        manager = await get_module_manager()

        if module_id not in manager.active_ownerships:
            return None

        ownership = manager.active_ownerships[module_id]

        return ModuleOwnershipResponse(
            module_id=ownership.module_id,
            owner_session=ownership.owner_session,
            developer_name=ownership.developer_name,
            status=ownership.status.value,
            started_at=ownership.started_at,
            estimated_completion=ownership.estimated_completion,
            actual_completion=ownership.actual_completion,
            completion_criteria=[c.value for c in ownership.completion_criteria],
            blockers=ownership.blockers,
            warnings=ownership.warnings,
            progress=ownership.progress,
            commits=ownership.commits
        )

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/active", response_model=List[ModuleOwnershipResponse])
async def get_active_modules():
    """
    활성 모듈 목록

    현재 개발 중인 모든 모듈 목록을 반환합니다.
    """
    try:
        manager = await get_module_manager()

        active_modules = []
        for module_id, ownership in manager.active_ownerships.items():
            active_modules.append(ModuleOwnershipResponse(
                module_id=ownership.module_id,
                owner_session=ownership.owner_session,
                developer_name=ownership.developer_name,
                status=ownership.status.value,
                started_at=ownership.started_at,
                estimated_completion=ownership.estimated_completion,
                actual_completion=ownership.actual_completion,
                completion_criteria=[c.value for c in ownership.completion_criteria],
                blockers=ownership.blockers,
                warnings=ownership.warnings,
                progress=ownership.progress,
                commits=ownership.commits
            ))

        return active_modules

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/check-rules")
async def check_standard_rules(
    action: str = Query(..., description="체크할 액션"),
    context: Dict[str, Any] = {}
):
    """
    Standard 레벨 규칙 체크

    특정 액션이 Standard 레벨 규칙을 준수하는지 확인합니다.
    """
    try:
        manager = await get_module_manager()

        allowed, warnings = await manager.check_standard_rules(action, context)

        return {
            "allowed": allowed,
            "warnings": warnings,
            "level": "Standard"
        }

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
