#!/usr/bin/env python3
"""
Check Knowledge Tables and Run Migration 003
"""
import psycopg2
from pathlib import Path
import logging

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

def check_tables_exist(conn):
    """Check if knowledge tables already exist"""
    cursor = conn.cursor()
    cursor.execute("""
        SELECT table_name
        FROM information_schema.tables
        WHERE table_schema = 'public'
        AND table_name LIKE 'knowledge%'
        ORDER BY table_name
    """)
    tables = [row[0] for row in cursor.fetchall()]
    return tables

def run_migration():
    """Run knowledge reuse schema migration"""
    db_config = {
        'host': 'localhost',
        'port': 5432,
        'database': 'udo_v3',
        'user': 'udo_dev',
        'password': 'dev_password_123'
    }

    try:
        # Connect
        conn = psycopg2.connect(**db_config)
        conn.autocommit = False
        logger.info(f"✅ Connected to database: {db_config['database']}")

        # Check existing tables
        existing_tables = check_tables_exist(conn)
        if existing_tables:
            logger.info(f"⚠️ Found existing knowledge tables: {existing_tables}")
            logger.info("Skipping migration (tables already exist)")
            conn.close()
            return

        logger.info("✅ No knowledge tables found, running migration...")

        # Read and execute migration SQL
        migration_file = Path(__file__).parent / "003_knowledge_reuse_schema.sql"
        with open(migration_file, 'r', encoding='utf-8') as f:
            sql_content = f.read()

        cursor = conn.cursor()
        cursor.execute(sql_content)

        # Record in schema_migrations
        cursor.execute("""
            INSERT INTO schema_migrations (version, filename, success)
            VALUES (%s, %s, %s)
        """, ('003_knowledge_reuse_schema', '003_knowledge_reuse_schema.sql', True))

        conn.commit()
        logger.info("✅ Migration 003 executed successfully")

        # Verify tables created
        new_tables = check_tables_exist(conn)
        logger.info(f"✅ Created tables: {new_tables}")

        conn.close()

    except Exception as e:
        logger.error(f"❌ Migration failed: {e}")
        if conn:
            conn.rollback()
            conn.close()
        raise

if __name__ == "__main__":
    run_migration()
