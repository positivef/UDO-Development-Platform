"""
Integration Test: Knowledge Reuse System (Week 7-8 PostgreSQL)

Tests all 7 API endpoints with actual database operations:
1. POST /api/knowledge/feedback
2. GET /api/knowledge/metrics
3. GET /api/knowledge/documents/{doc_id}/score
4. GET /api/knowledge/improvement-suggestions
5. DELETE /api/knowledge/feedback/{feedback_id}
6. GET /api/knowledge/search
7. GET /api/knowledge/search/stats
"""
import pytest
import requests
import time
from datetime import datetime, timezone

BASE_URL = "http://localhost:8000"

def test_health_check():
    """Test health endpoint"""
    response = requests.get(f"{BASE_URL}/api/knowledge/health")
    assert response.status_code == 200
    data = response.json()
    assert data["status"] == "ok"
    assert data["router"] == "knowledge-feedback"
    print("✅ Health check passed")

def test_submit_feedback():
    """Test feedback submission (creates database entry)"""
    feedback = {
        "document_id": "test_doc_001.md",
        "search_query": "authentication error 401",
        "is_helpful": True,
        "reason": None,
        "session_id": "test_session_001",
        "implicit_accept": True
    }

    response = requests.post(f"{BASE_URL}/api/knowledge/feedback", json=feedback)
    assert response.status_code == 201

    data = response.json()
    assert "feedback_id" in data
    assert "message" in data
    assert "timestamp" in data

    print(f"✅ Feedback submitted: {data['feedback_id']}")
    return data["feedback_id"]

def test_get_metrics():
    """Test metrics retrieval (reads from database)"""
    response = requests.get(f"{BASE_URL}/api/knowledge/metrics?days=7")
    assert response.status_code == 200

    data = response.json()
    assert "search_accuracy" in data
    assert "acceptance_rate" in data
    assert "false_positive_rate" in data
    assert "total_searches" in data
    assert "total_feedback_count" in data

    print(f"✅ Metrics retrieved: {data['total_feedback_count']} feedback entries")
    print(f"   Search accuracy: {data['search_accuracy']}%")
    print(f"   Acceptance rate: {data['acceptance_rate']}%")

def test_get_document_score():
    """Test document score retrieval"""
    # First submit feedback to create score
    feedback = {
        "document_id": "test_doc_002.md",
        "search_query": "performance optimization",
        "is_helpful": True,
        "implicit_accept": True
    }
    requests.post(f"{BASE_URL}/api/knowledge/feedback", json=feedback)

    # Then retrieve score
    response = requests.get(f"{BASE_URL}/api/knowledge/documents/test_doc_002.md/score")
    assert response.status_code == 200

    data = response.json()
    assert data["document_id"] == "test_doc_002.md"
    assert "usefulness_score" in data
    assert "total_searches" in data
    assert "acceptance_rate" in data

    print(f"✅ Document score: {data['usefulness_score']:.2f} ({data['total_searches']} searches)")

def test_get_document_score_not_found():
    """Test document score for non-existent document"""
    response = requests.get(f"{BASE_URL}/api/knowledge/documents/nonexistent.md/score")
    assert response.status_code == 404
    print("✅ 404 for non-existent document (expected)")

def test_improvement_suggestions():
    """Test improvement suggestions (analytics)"""
    # Create low-quality document
    for i in range(3):
        feedback = {
            "document_id": "low_quality_doc.md",
            "search_query": f"test query {i}",
            "is_helpful": False,
            "reason": "Not helpful"
        }
        requests.post(f"{BASE_URL}/api/knowledge/feedback", json=feedback)

    time.sleep(0.5)  # Allow database to update

    response = requests.get(f"{BASE_URL}/api/knowledge/improvement-suggestions")
    assert response.status_code == 200

    suggestions = response.json()
    assert isinstance(suggestions, list)

    # Should have at least one suggestion for low_quality_doc.md
    low_quality_suggestions = [s for s in suggestions if s.get("document_id") == "low_quality_doc.md"]
    assert len(low_quality_suggestions) > 0

    print(f"✅ Improvement suggestions: {len(suggestions)} total")
    for s in low_quality_suggestions:
        print(f"   - {s['type']}: {s['document_id']} (score: {s.get('score', 'N/A')})")

def test_search_endpoint():
    """Test 3-tier search endpoint"""
    response = requests.get(
        f"{BASE_URL}/api/knowledge/search",
        params={"query": "authentication", "max_results": 5}
    )
    assert response.status_code == 200

    data = response.json()
    assert "query" in data
    assert "total_results" in data
    assert "results" in data
    assert "search_time_ms" in data
    assert "tier_breakdown" in data

    print(f"✅ Search executed: {data['total_results']} results in {data['search_time_ms']:.2f}ms")
    print(f"   Tier breakdown: T1={data['tier_breakdown']['tier1']}, T2={data['tier_breakdown']['tier2']}, T3={data['tier_breakdown']['tier3']}")

def test_search_stats():
    """Test search statistics endpoint"""
    # First perform a search to create stats
    requests.get(f"{BASE_URL}/api/knowledge/search", params={"query": "test"})

    time.sleep(0.5)  # Allow database to update

    response = requests.get(f"{BASE_URL}/api/knowledge/search/stats?days=7")
    assert response.status_code == 200

    data = response.json()
    assert "total_searches" in data
    assert "avg_search_time_ms" in data
    assert "tier1_hit_rate" in data
    assert "tier2_hit_rate" in data
    assert "tier3_hit_rate" in data

    print(f"✅ Search stats: {data['total_searches']} searches")
    print(f"   Avg time: {data['avg_search_time_ms']:.2f}ms")
    print(f"   Tier hit rates: T1={data['tier1_hit_rate']}%, T2={data['tier2_hit_rate']}%, T3={data['tier3_hit_rate']}%")

def test_delete_feedback():
    """Test feedback deletion (admin operation)"""
    # First create feedback
    feedback = {
        "document_id": "delete_test.md",
        "search_query": "test delete",
        "is_helpful": True
    }
    response = requests.post(f"{BASE_URL}/api/knowledge/feedback", json=feedback)
    feedback_id = response.json()["feedback_id"]

    # Then delete it
    response = requests.delete(f"{BASE_URL}/api/knowledge/feedback/{feedback_id}")
    assert response.status_code == 204

    print(f"✅ Feedback deleted: {feedback_id}")

def test_delete_feedback_not_found():
    """Test deletion of non-existent feedback"""
    fake_id = "00000000-0000-0000-0000-000000000000"
    response = requests.delete(f"{BASE_URL}/api/knowledge/feedback/{fake_id}")
    assert response.status_code == 404
    print("✅ 404 for non-existent feedback (expected)")

if __name__ == "__main__":
    print("\n" + "="*60)
    print("Knowledge Reuse Integration Test (PostgreSQL)")
    print("="*60 + "\n")

    try:
        test_health_check()
        test_submit_feedback()
        test_get_metrics()
        test_get_document_score()
        test_get_document_score_not_found()
        test_improvement_suggestions()
        test_search_endpoint()
        test_search_stats()
        test_delete_feedback()
        test_delete_feedback_not_found()

        print("\n" + "="*60)
        print("✅ ALL TESTS PASSED (10/10)")
        print("="*60 + "\n")

    except AssertionError as e:
        print(f"\n❌ Test failed: {e}")
        raise
    except Exception as e:
        print(f"\n❌ Unexpected error: {e}")
        raise
